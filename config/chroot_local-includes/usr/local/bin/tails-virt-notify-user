#!/usr/bin/perl

use strict;
use warnings;

#man{{{

=head1 NAME

tails-virt-notify-user

=head1 VERSION

Version X.XX

=head1 AUTHOR

Tails dev team <amnesia@boum.org>
See https://tails.boum.org/.

=cut

#}}}

use Desktop::Notify;
use IPC::System::Simple qw{runx};
use Locale::gettext;
use POSIX;

### initialization
setlocale(LC_MESSAGES, "");
textdomain("tails");
my @detected_virt_command=qw{};

### main

my @detected_virt;

# both 0 and 1 are acceptable exit values:
#  - 0 means that we're running in a virtualized environment
#  - 1 means that we're not running in a virtualized environment
#  - anything else means there is a problem, and runx will throw an exception
my $exit_value = runx([0, 1], qw{/usr/bin/systemd-detect-virt});

exit 0 if $exit_value == 1;

my $notify = Desktop::Notify->new();

my $summary = gettext("Warning: virtual machine detected!");
my $body    =
    gettext("Both the host operating system and the virtualization software are able to monitor what you are doing in Tails.")
    . " "
    . gettext("<a href='file:///usr/share/doc/tails/website/doc/advanced_topics/virtualization.en.html'>Learn more...</a>")
    . " "; # Workaround: else the last line of the notification is not displayed

$notify->create(summary => $summary,
                body => $body,
                timeout => 0)->show();
